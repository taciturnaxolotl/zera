{% if config.extra.header_nav %}
{% if page %}
{% set active_path = page.path | trim_end_matches(pat="/") %}
{% elif section %}
{% set active_path = section.path | trim_end_matches(pat="/") %}
{% elif current_path %}
{% set active_path = current_path | trim_end_matches(pat="/") %}
{% else %}
{% set active_path = "" %}
{% endif %}
<div id="header-container">
  <span id="now-playing"></span>
  <nav id="nav-bar">
    {% for nav_item in config.extra.header_nav %}
    <a href="{{ nav_item.url }}"
      class="{% if nav_item.url == active_path or (nav_item.url == '/' and active_path == '') %}active{% endif %}">
      {{ nav_item.name }}
    </a>
    {% endfor %}
  </nav>
</div>
<script>
  let nowPlayingTimeout = null;
  function fetchNowPlaying() {
    if (nowPlayingTimeout) clearTimeout(nowPlayingTimeout);
    fetch("https://bsky.social/xrpc/com.atproto.repo.getRecord?repo=did:plc:krxbvxvis5skq7jj6eot23ul&collection=fm.teal.alpha.actor.status&rkey=self")
      .then((response) => response.ok ? response.json() : null)
      .then((data) => {
        const el = document.getElementById("now-playing");
        if (!data?.value?.item) {
          el.innerHTML = "";
          nowPlayingTimeout = setTimeout(fetchNowPlaying, 60000);
          return;
        }
        const item = data.value.item;
        const expiry = parseInt(data.value.expiry, 10) * 1000;
        const now = Date.now();
        if (now > expiry) {
          el.innerHTML = "";
          nowPlayingTimeout = setTimeout(fetchNowPlaying, 60000);
          return;
        }
        el.innerHTML = `ðŸŽµ&nbsp;<a href="${item.originUrl || '#'}" target="_blank" rel="noopener"><span class="track-name">${item.trackName}</span></a>&nbsp;-&nbsp;<span class="artist-name">${item.artists?.[0]?.artistName || 'Unknown'}</span>`;
        const timeUntilExpiry = expiry - now + 1000;
        nowPlayingTimeout = setTimeout(fetchNowPlaying, timeUntilExpiry);
      })
      .catch(() => {
        nowPlayingTimeout = setTimeout(fetchNowPlaying, 60000);
      });
  }
  document.addEventListener("DOMContentLoaded", fetchNowPlaying);
</script>
{% endif %}